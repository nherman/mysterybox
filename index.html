<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <style type="text/css">
            html {
                height:100%;
            }
            body {
                height:100%;
                margin:0;
                background-color: #eee;
            }
            .mysterybox {
                position:absolute;
                width: 306px;
                height: 306px;
                top:50%;
                left:50%;
                margin-top:-175px;
                margin-left:-150px;
                padding:2px 1px 2px 4px;

                border:1px solid #aaa;
                background-color:#fafafa;
                word-wrap: break-word;

                font-family: "Courier New", Courier, monospace;
                font-size:14px;
                line-height:17px;
                font-weight:normal;
            }
        </style>

    <body>

        <pre class="mysterybox" id="mysterybox"></pre>

        <!-- script src="mysterybox.js" -->
        <script>
            window.MYSTERYBOX = window.MYSTERYBOX || (function() {
                "use strict";

                var 

                    /* prevent calls to console.log from throwing an error in browsers that don't support it */
                    console = window.console || {log:function(){ return; }},

                    /* shortcut saves extra prototype tree traversals */
                    hasOwnProp = Object.prototype.hasOwnProperty,

                    /* helper function returns true if passed an object that contains ownPropeties */
                    hasOwn = function(obj) {
                        var key;
                        if (obj === undefined || !obj instanceof Object) { return false; }
                        for (key in obj) {
                            if (hasOwnProp.call(obj, key)) { return true; }
                        }
                        return false;
                    },

                    /* 
                        Extend: helper function for copying parameters from one object to another.
                        Not a "full" object copy.  Arrays are assume to be flat, and contain only strings. Object depth limited
                    */
                    extend = function(obj, extension, overwrite, depth){
                        var i, j, key,
                            maxDepth=1; //keep copies shallow in case there's a bug in the config
                        if (overwrite !== false) {
                            overwrite = true;
                        }
                        if (depth === undefined) {
                            depth = 0;
                        }
                        for (key in extension){
                            if (hasOwnProp.call(extension, key)) {

                                /* copy arrays - only arrays of strings allowed */
                                if (extension[key] instanceof Array) {
                                    if (!obj[key] instanceof Array && !overwrite) continue;
                                    /* http://stackoverflow.com/questions/1584370 */
                                    obj[key] = (obj[key] || []).concat(extension[key]);
                                    for (i=0; i<obj[key].length; ++i) {
                                        for (j=i+1; j<obj[key].length; ++j) {
                                            if (obj[key][i] === obj[key][j]) {
                                                obj[key].splice(j--,1);
                                            }
                                        }
                                    }
                                } else if (extension[key] instanceof Object) {
                                    if (!obj[key] instanceof Object && !overwrite) continue;

                                    obj[key] = obj[key] || {};
                                    if (depth <= maxDepth) {
                                        extend(obj[key],extension[key],overwrite,depth++);
                                    }

                                } else if (obj[key] === undefined || overwrite) {
                                    obj[key] = extension[key];
                                }

                                
                            }
                        }
                    };

                function box(options) {
                    this.options = {
                        cols: 36,
                        rows: 18,
                        message: "The quick brown fox jumped over the two lazy dogs",
                        domElmId: ""
                    };
                    extend(this.options, options);

                    this.total = this.options.rows * this.options.cols;
                    this.buffer = [];
                    this.cleanChars = [];
                    this.msg = this.options.message;

                    if (this.options.domElmId == "") {
                        this.domElm = document.getElementsByTagName("body")[0];
                    } else {
                        this.domElm = document.getElementById(this.options.domElmId);
                    }

                    this.init();
                }

                box.prototype.init = function(msg) {
                    if (msg !== undefined) {
                        this.msg = msg;
                    }
                    this.populateBuffer();
                }

                box.prototype.initRandom = function() {
                    for (var i=0;i<totalChars;i++) {
                        domElm.innerHTML += this.getRandLatin();
                    }

                }

                box.prototype.updateChar = function(recurse) {
                    if (this.cleanChars.length) {
                        var j = Math.floor(Math.random() * this.cleanChars.length);
                        var i = this.cleanChars[j];
                        this.cleanChars.splice(j,1);

                        this.domElm.innerHTML = this.domElm.innerHTML.substring(0,i) + this.buffer[i] + this.domElm.innerHTML.substring(i+1);
                        if (recurse !== undefined && recurse) {
                            setTimeout((function() {this.updateChar(true);}).apply(this), 0);
                        }
                    }
                }

                box.prototype.populateBuffer = function() {
                    var msgRows = Math.ceil(this.msg.length/this.options.cols),
                        rowLength = Math.ceil(this.msg.length/msgRows),
                        msgArr = this.msg.split(" "),
                        cursor = Math.floor((this.options.rows - msgRows)/2) * this.options.cols,
                        nextLen = 0,
                        line = "";

                    while (msgArr.length > 0) {
                        line += msgArr[0];
                        msgArr.splice(0,1);
                        try {
                            nextLen = msgArr[0].length;
                        } catch (e) {}


                        if (line.length >= rowLength || line.length + nextLen > this.options.cols || nextLen == 0) {
                            // write line to buffer
                            cursor += Math.floor((this.options.cols - line.length)/2)  //pad left

                            for (i=0;i<line.length;i++) {
                                this.buffer[cursor++] = line.charAt(i);
                            }

                            cursor += Math.ceil((this.options.cols - line.length)/2)  //pad right
                            line = "";
                        } else {
                            line += " ";
                        }
                    }

                    /* fill in whitespace */
                    for (var i=0;i<this.total;i++) {
                        this.cleanChars[i] = i;
                        if (this.buffer[i] === undefined) {
                            this.buffer[i] = "\u0020";
                        }
                    }

                }

                box.prototype.getRandLatin = function() {
//                return String.fromCharCode(0x30A0 + Math.random() * (0x30FF-0x30A0+1));   //katakana
//                return String.fromCharCode(0x0041 + Math.random() * (0x005A-0x0041+1));   //uppercase A-Z
                    return String.fromCharCode(0x0061 + Math.random() * (0x007A-0x0061));      //lowercase a-z
                }

                /*
                * expose box class
                */
                return function(options) {
                    return new box(options);
                }

            }());

            var mb = window.MYSTERYBOX({
                message: "These are times that try men's souls!",
                domElmId: "mysterybox"
            });
//            window.onload = mb.updateChar(true);



            var cols = 36,
                rows = 18,
                totalChars = rows * cols;
            var message = "The quick brown fox jumped over the two lazy dogs";
            var arr = [];
            var dirty = [];

            for (var i=0;i<totalChars;i++) {
                dirty[i] = i;
            }

            placeMsg(message);


            function placeMsg(message) {
                var msgRows = Math.ceil(message.length/cols),
                    rowLength = Math.ceil(message.length/msgRows),
                    msgArr = message.split(" ");


                //prepend spaces
                var cursor = Math.floor((rows - msgRows)/2) * cols;

                var line = "";
                while (msgArr.length > 0) {
                    line += msgArr[0];
                    msgArr.splice(0,1);
                    try {
                        nextLen = msgArr[0].length;
                    } catch (e) {
                        nextLen = 0;
                    }


                    if (line.length >= rowLength || line.length + nextLen > cols || nextLen == 0) {
                        // write line to buffer
                        cursor += Math.floor((cols - line.length)/2)  //pad left

                        for (i=0;i<line.length;i++) {
                            arr[cursor++] = line.charAt(i);
                        }

                        cursor += Math.ceil((cols - line.length)/2)  //pad right
                        line = "";
                    } else {
                        line += " ";
                    }
                }
            }





            function changeChar() {
                var mb = document.getElementById('mysterybox');

                if (dirty.length) {
                    var j = Math.floor(Math.random() * dirty.length);
                    var i = dirty[j];
                    dirty.splice(j,1);

                    if (arr[i] === undefined) {
                        arr[i] = "\u0020";
                    }

                    mb.innerHTML = mb.innerHTML.substring(0,i) + arr[i] + mb.innerHTML.substring(i+1);
                    setTimeout(changeChar, 0);
                }
            }

            function populate() {
                var mb = document.getElementById('mysterybox'),
                    i=0;

                for (;i<totalChars;i++) {
                    mb.innerHTML += getRandLatin();
                }

                changeChar();
                changeChar();


            }

            function getRandLatin() {
//                return String.fromCharCode(0x30A0 + Math.random() * (0x30FF-0x30A0+1));   //katakana
//                return String.fromCharCode(0x0041 + Math.random() * (0x005A-0x0041+1));   //uppercase A-Z
                return String.fromCharCode(0x0061 + Math.random() * (0x007A-0x0061));      //lowercase a-z
            }
        </script>
    </body>
</html>